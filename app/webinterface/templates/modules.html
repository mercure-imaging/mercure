{% extends "base.html" %}

{% block title %}Modules{% endblock %}

{% block content %}
<style>
    .radiobuttons > input:checked + label{
        background: black;
        color: white;
    }
    #modulesmodal {
        align-items: start;
        flex-direction: row;
        justify-content: end;
    }
    #modulesmodal .modal-card {
        max-height: 100%;
        min-height: 100%;
        margin-right: 0;
    }
    #dynamic-modules-content {
        overflow-y: auto;
        overflow-x: hidden;
    }
    #browseaddmodal {
        padding-left: 10px;
        padding-right: 10px;
    }
    .module-item {
        background-color: #fff;
        border: 1px solid #ddd;
        margin: 10px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .module-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .cover-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
    }
</style>
    <main role="main">
        <div class="container">
            <h1 class="title is-4">Processing Modules</h1>
            <div class="field is-grouped" style="margin-bottom: 16px;">
                <div class="control has-icons-left">
                    <input class="input" type="text" id="searchInput" placeholder="Search..." value="">
                    <span class="icon is-small is-left">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
                <div class="control is-expanded">
                </div>                
                {% if is_admin %}
                <div class="">
                    <button id="show_add_modal" class="button is-success"><span class="icon"><i class="fas fa-plus"></i></span><span>Add</span></button>
                </div>
                {% endif %}
            </div>
    
            {% for module_name, module in modules.items()|sort() %}
                <div class="card entitycard" data-name="{{module_name}} {{module.docker_tag}}">
                    <header class="card-header has-background-light">
                        <p class="card-header-title card-toggle">
                            <span class="icon"><i class="fas fa-cogs fa-lg"></i></span>&nbsp;&nbsp;{{ module_name }}
                            <span style="margin-left: auto; font-weight: 200;">{{module.docker_tag|truncate(50, True)}}</span>
                        </p>
                        <a class="card-header-icon card-toggle">
                            <i class="fa fa-angle-down"></i>
                        </a>
                    </header>
                    <div class="card-content entitycard-content is-hidden">
                        <div class="content">
                            <table class="table is-narrow" style="margin-bottom: 8px;">
                                <col width="150">
                                <tr>
                                    <td>Docker Tag:</td>
                                    <td>{{ module.docker_tag }}</td>
                                </tr>
                                <tr>
                                    <td>Contact:</td>
                                    <td>{{ module.contact }}</td>
                                </tr>                                
                                <tr>
                                    <td>Comment:</td>
                                    <td>{{ module.comment }}</td>
                                </tr>                                
                            </table>
                            <div class="buttons is-right">
                                {% if is_admin %}
                                    <a class="button is-success" href="/modules/edit/{{module_name}}"><span class="icon"><i
                                            class="fas fa-pen"></i></span><span>Edit</span></a>
                                    <button class="button is-danger delete-button" value="{{module_name}}"
                                            {% if module_name in used_modules%}disabled
                                            title="Cannot delete because target is used by rule '{{ used_module }}'" {% endif %}><span class="icon"><i
                                            class="fas fa-trash-alt"></i></span><span>Delete</span></button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
            <nav class="pagination is-centered" role="navigation" aria-label="pagination" style="margin-top: 16px;">
                <ul class="pagination-list" id="paginationList">
                </ul>
            </nav>   
        </div>

        <div class="modal" id="addmodal">
            <div class="modal-background">
            </div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Install New Module</p>
                </header>
                <section class="modal-card-body">
                    <form hx-post="./" hx-target="#addmodal_message" htmx-added="title">
                        <div class="field">
                            <p class="control">
                                <input class="input" id="addnewname" type="text" required pattern="[0-9a-zA-Z_\-]+"
                                       placeholder="Name of module" name="name" autofocus>
                            </p>
                        </div>
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <input class="input" id="docker_tag" type="text" required pattern="[a-zA-Z0-9-:/_.@]+" placeholder="Docker tag" name="docker_tag" >
                            </div>
                            <div class="control">
                                <button id="browseaddmodal" class="button is-success" type="button">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                        <div class="field" style="margin-top: 20px; margin-bottom: 25px;">
                            <label class="label">Module Type</label>
                            <div class="control radiobuttons radiobuttons_module">
                                <input type="radio" value="mercure" id="radio_mercure" name="container_type" style="display:none" checked>
                                <label class="button containerradiobtn" for="radio_mercure" style="border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-top-left-radius: 290486px; border-bottom-left-radius: 290486px; padding-right: 4px;">
                                 mercure
                                </label>
                                <input type="radio" value="monai" id="radio_monai" name="container_type" style="display:none">
                                <label class="button containerradiobtn" for="radio_monai" style="margin-left: -5px; border-top-left-radius: 0px; border-bottom-left-radius: 0px; border-top-right-radius: 290486px; border-bottom-right-radius: 290486px; padding-left: 4px;" title="Select for running MONAI applications">
                                 MONAI
                                </label>
                            </div>
                        </div>
                        <div class="field" style="margin-top: 20px;"><span id="addmodal_message" style="color:#ff3860;"></span></div>
                        <div class="field" style="margin-top: 25px;">
                            <div class="control">
                                <button id="confirmaddmodal" class="button is-success">Install</button>
                                <a id="closeaddmodal" class="button">Cancel</a>
                                <i class="fas fa-spin fa-spinner htmx-indicator" style="font-size: 1.5em; float: right !important;"></i>
                            </div>                            
                        </div>
                    </form>
                </section>
            </div>
        </div>
        <div class="modal" id="deletemodal">
            <div class="modal-background">
            </div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Delete Module?</p>
                </header>
                <section class="modal-card-body">
                    <div class="field">
                        Are you sure to delete the module? This cannot be undone.
                    </div>
                    <div class="field" style="margin-top: 20px;">
                        <p class="control">
                            <button id="confirmdeletemodal" class="button is-danger">Delete</button>
                            <a id="closedeletemodal" class="button">Cancel</a>
                        </p>
                    </div>
            </section>
            </div>
        </div>
        <div id="modulesmodal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Available Modules</p>
                </header>
                <section class="modal-card-body">
                    <div class="tabs is-fullwidth" id="modules-tabs">
                        <ul>
                            <li class="is-active" data-tab="online"><a><span class="icon is-small"><i class="fas fa-globe"></i></span> <span>Online Registry</span></a></li>
                            <li data-tab="local"><a><span class="icon is-small"><i class="fas fa-hdd"></i></span> <span>Local Images</span></a></li>
                        </ul>
                    </div>
                    <div class="control has-icons-left is-fullwidth" style="margin-bottom: 10px;">
                        <input class="input" type="text" id="modules-search-input" placeholder="Search..." value="">
                        <span class="icon is-small is-left">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <div id="dynamic-modules-content"></div>
                </section>
                <footer class="modal-card-foot">
                <div class="buttons">
                    <button id="closemodulesmodal" class="button">Close</button>
                </div>
                </footer>
            </div>
        </div>
    </main>

    <script nonce="{{ csp_nonce }}">
        $('.delete-button').click((evt) => {
            confirmDelete(evt.target.closest('button').value)
        })

        document.addEventListener('DOMContentLoaded', function () {
            let cardToggles = document.getElementsByClassName('card-toggle');
            for (let i = 0; i < cardToggles.length; i++) {
                cardToggles[i].addEventListener('click', e => {
                    e.currentTarget.parentElement.parentElement.childNodes[3].classList.toggle('is-hidden');
                });
            }
            paginate(document.getElementsByClassName('entitycard'))
        });

        function showAddModal() {
            $("#addnewname").val("");
            $("#addmodal").addClass("is-active");
            $("#addnewname").focus();
        }
        $('#show_add_modal').click(showAddModal)
        var moduleToDelete = "";

        function confirmDelete(val) {
            moduleToDelete = val;
            $("#deletemodal").addClass("is-active");
        }

        $(function () {
            $('#closeaddmodal').click(function () {
                $("#addmodal").removeClass("is-active");
                $("#addmodal_message").html("")
            })

            $('#closedeletemodal').click(function () {
                $("#deletemodal").removeClass("is-active");
            })

            $('#confirmdeletemodal').click(function () {
                $("#deletemodal").removeClass("is-active");
                var url = '/modules/delete/' + moduleToDelete;
                var form = $('<form action="' + url + '" method="post"></form>');
                $('body').append(form);
                form.submit();
            })

            $("#closemodulesmodal").click(function() {
                $("#modulesmodal").removeClass("is-active");
            });

            const defaultCoverUrl = "{{ url_for('static', path='favicon-32x32.png') }}";
            let onlineModules = [];
            let locallyInstalledImages = [];
            let modulesCacheTimestamp = null;
            const MODULES_CACHE_TTL = 60 * 1000;

            function renderModulesTab(tab) {
                let modulesList = $('#dynamic-modules-content');
                modulesList.empty();
                let searchVal = ($('#modules-search-input').val() || '').toLowerCase();
                if (tab === 'online') {
                    let filtered_online = onlineModules.filter(module => {
                        return module.name.toLowerCase().includes(searchVal) || (module.description && module.description.toLowerCase().includes(searchVal));
                    });
                    if (filtered_online.length === 0) {
                        modulesList.append('<p>No online modules found.</p>');
                        return;
                    }
                    filtered_online.forEach(module => {
                        let coverUrl = module.coverUrl || defaultCoverUrl;
                        let moduleItem = `
                            <div class="module-item" data-module='${JSON.stringify(module)}'>
                                <img src="${coverUrl}" alt="${module.name} cover image" class="cover-image">
                                <b>${module.name}</b>
                                <p>${module.description}</p>
                                <a href="${module.githubUrl}" target="_blank"><i class="fab fa-github"></i></a>
                            </div>`;
                        modulesList.append(moduleItem);
                    });
                } else if (tab === 'local') {
                    let filtered_local = locallyInstalledImages.filter(image => {
                        let name = image.split('/').pop().split(':')[0];
                        return name.toLowerCase().includes(searchVal);
                    });
                    if (filtered_local.length === 0) {
                        modulesList.append('<p>No local images found.</p>');
                        return;
                    }
                    filtered_local.forEach(image => {
                        let module = {
                            name: image.split('/').pop().split(':')[0],
                            description: "Locally installed image",
                            dockerhubImage: image,
                            githubUrl: "#",
                            coverUrl: defaultCoverUrl
                        };
                        let moduleItem = `
                            <div class="module-item" data-module='${JSON.stringify(module)}'>
                                <img src="${defaultCoverUrl}" alt="${module.name} cover image" class="cover-image">
                                <b>${module.name}</b>
                                <p>${module.description}</p>
                                <a href="${module.githubUrl}" target="_blank"><i class="fab fa-github"></i></a>
                            </div>`;
                        modulesList.append(moduleItem);
                    });
                }
                let modulesBody = $('#modulesmodal').find('.modal-card-body');
                modulesBody.animate({scrollTop: 0}, 200);
            }

            function fetchAndCacheModules(forceReload = false) {
                $('#modules-tabs li').removeClass('is-active');
                $('#modules-tabs li[data-tab="online"]').addClass('is-active');
                $("#modules-search-input").val("");

                let now = Date.now();
                if (!forceReload && modulesCacheTimestamp && (now - modulesCacheTimestamp < MODULES_CACHE_TTL) && onlineModules.length > 0) {
                    renderModulesTab('online');
                    $("#modulesmodal").addClass("is-active");
                    return;
                }

                let modulesList = $('#dynamic-modules-content');
                modulesList.empty();
                modulesList.append('<i class="fas fa-spin fa-spinner"></i>');

                $.ajax({
                    type: 'GET',
                    url: '/modules/fetch_registry',
                    data: {},
                    dataType: 'json',
                    error: function () {
                        $("#modulesmodal").removeClass("is-active");
                        alert("Error fetching available modules. Try again!");
                    },
                    success: function (modules) {
                        onlineModules = JSON.parse(modules.online_modules);
                        locallyInstalledImages = modules.installed_images;
                        modulesCacheTimestamp = Date.now();
                        renderModulesTab('online');
                    },
                    timeout: 3000
                });
                $("#modulesmodal").addClass("is-active");
            }

            $("#browseaddmodal").click(function(event) {
                event.preventDefault();
                fetchAndCacheModules();
            });

            $("#modules-search-input").on("input", function() {
                let tab = $('#modules-tabs li.is-active').data('tab');
                renderModulesTab(tab);
            });

            $(document).on('click', '#modules-tabs li', function() {
                $('#modules-tabs li').removeClass('is-active');
                $(this).addClass('is-active');
                let tab = $(this).data('tab');
                renderModulesTab(tab);
            });

            $(document).on('click', '.module-item', function() {
                let moduleData = $(this).data('module');
                $("#addnewname").val(moduleData.name);
                if (moduleData.dockerhubImage) {
                    $("#docker_tag").val(moduleData.dockerhubImage);
                } else {
                    $("#docker_tag").val("");
                }
                $("#modulesmodal").removeClass("is-active");
            });
        });
    </script>

{% endblock %}