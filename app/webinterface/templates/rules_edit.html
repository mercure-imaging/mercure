{% extends "base.html" %}

{% block title %}Rules{% endblock %}
{% block extra_head %}
<script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='/js/bulma-quickview.min.js') }}"></script>
<script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='/js/dicomParser.min.js') }}"></script>
<script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='/js/dataDictionary.js') }}"></script>
<script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='/js/choices.js') }}"></script>
<link href="{{ url_for('static', path='/css/choices.css') }}" rel="stylesheet">

{% endblock %}
{% block content %}
<main role="main">
    <div class="container">
        <h1 class="title is-4">Edit Rule - {{rule}}</h1>

        <div class="notification is-danger" id="erroralert" style="display: none;">
            <i class="fas fa-bug"></i>&nbsp;&nbsp;Error in configuration detected. Please check input fields for correct
            syntax.
        </div>

        <div class="tabs is-centered is-toggle is-toggle-rounded" style="margin-top: 30px;" id="tabs">
            <ul>
                <li data-tab="filtering" class="is-active">
                    <a>
                        <span class="icon"><i class="fas fa-filter"></i></span>
                        <span>Filtering</span>
                    </a>
                </li>
                <li data-tab="processing">
                    <a id="processing_id">
                        <span class="icon"><i class="fa fa-microchip"></i></span>
                        <span>Processing</span>
                    </a>
                </li>
                <li data-tab="routing">
                    <a id="routing_id">
                        <span class="icon"><i class="fa fa-directions"></i></span>
                        <span>Routing</span>
                    </a>
                </li>
                <li data-tab="notification">
                    <a>
                        <span class="icon"><i class="fa fa-bullhorn"></i></span>
                        <span>Notification</span>
                    </a>
                </li>
                <li data-tab="information">
                    <a>
                        <span class="icon"><i class="fa fa-info-circle"></i></span>
                        <span>Information</span>
                    </a>
                </li>
            </ul>
        </div>

        <form method="post">
            <div id="tab-content">
                <div class="panel is-active" data-content="filtering">
                    <div class="field">
                        <label class="label">Selection Rule</label>
                        <div class="field has-addons">
                            <div class="control">
                                <button id="toggletestrule" class="button" type="button" title="Test Rule">
                                    <i class="fas fa-cogs"></i>
                                </button> 
                            </div>
                            <div class="control is-expanded">
                                <textarea rows="1" name="rule" id="rule" class="textarea testinclude textarea_scroll" autocomplete='off'
                                    type="text"
                                    placeholder="Routing rule"
                                    style="border-top-left-radius: 0px; border-bottom-left-radius: 0px; padding-top: 5px; padding-bottom: 5px; min-height: 36px; height: 36px;">{{rules[rule]['rule']}}</textarea>
                            </div>
                        </div>
                    </div>
                    <div id="testrule" style="display: none;">
                        <div class="card column is-12" style="margin-left: auto; margin-right:auto; margin-top: 1em; margin-bottom: 1em; padding: 0em;">
                            <header class="card-header has-background-light">
                                <p class="card-header-title">
                                    <i class="fa fa-cogs"></i>&nbsp; Rule Tester
                                </p>
                            </header>                            
                            <div class="card-content">
                                <div class="content">
                                    <div class="container">
                                        <div class="field">
                                            <label class="label">Result:</label>
                                            <div id="testresult" style="min-height: 3em;"></div>
                                        </div>
                                        <div class="buttons">
                                            <button class="button is-dark" default autofocus id="evaltestrule" hx-post="/rules/test"
                                                hx-include=".testinclude"  hx-target="#testresult"><span class="icon"><i class="fas fa-play"></i></span><span>Run Test</span></button>
                                            <button class="button" type="button" id="resettestrule"><span class="icon"><i class="fas fa-undo-alt"></i></span><span>Reset</span></button>
                                        </div>
    
                                        <div class="field">
                                            <label class="label">Test Values:</label>
                                            <div class="control">
                                                <textarea class="textarea testinclude textarea_scroll monofont" rows="8" placeholder="Testing tags" id="testvalues"
                                                    data-json
                                                    name="testvalues" spellcheck="false">{{alltags|tojson(indent=4)}}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="tile is-ancestor" style="margin-top: 0.5em; user-select: none;">
                                        <div class="tile is-vertical is-12">
                                            <div class="tile" style="min-height: 8em;">
                                                <div class="tile is-parent is-vertical" id="dropZone">
                                                    <article class="tile is-child notification is-light ruletesterdashed">
                                                        <p class="title is-5" style="text-align: center; margin-bottom: 0.5em;"><i class="fas fa-file-upload"></i>&nbsp; Drag &amp; drop DICOM file here</p>
                                                        <p id="dropStatus" style="text-align: center">&nbsp;</p>
                                                    </article>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <article id="characterSetWarning" class="message is-warning is-hidden">
                                        <div class="message-header">
                                        <p>Unsupported Character Set</p>
                                        </div>
                                        <div class="message-body">
                                            This testing tool does not support the character set and may behave differently from the rule evaluator on the mercure server.
                                        </div>
                                    </article>
                                </div>
                            </div>            
                        </div>
                    </div>
                    <div class="field is-grouped is-grouped-right">
                        <button class="button" type="button" data-show="quickview" data-target="quickviewDefault"
                            style="margin: 0px;">
                            <span class="icon"><i class="fas fa-tags"></i></span><span>Available Tags</span>
                        </button>
                    </div>

                    <div class="field">
                        <label class="label">Action</label>
                        <div class="select">
                            <div class="control">
                                <select name="action" id="action">
                                    <option value="route" {% if rules[rule]['action']=='route' %}selected{% endif%}>
                                        Routing</option>
                                    <option value="both" {% if rules[rule]['action']=='both' %}selected{% endif%}>
                                        Processing & Routing</option>
                                    <option value="process" {% if rules[rule]['action']=='process' %}selected{% endif%}>
                                        Processing Only</option>
                                    <option value="notification" {% if rules[rule]['action']=='notification'
                                        %}selected{% endif%}>Notification
                                        Only</option>
                                    <option value="discard" {% if rules[rule]['action']=='discard' %}selected{% endif%}>
                                        Force Discard</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field" style="margin-top: 40px;">
                        <label class="label">Trigger</label>
                        <div class="select">
                            <div class="control">
                                <select name="action_trigger" id="action_trigger">
                                    <option value="series" {% if rules[rule]['action_trigger']=='series' %}selected{%
                                        endif%}>Completed
                                        Series</option>
                                    <option value="study" {% if rules[rule]['action_trigger']=='study' %}selected{%
                                        endif%}>Completed
                                        Study</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field" id="study_trigger_field">
                        <label class="label">Completion Condition</label>
                        <div class="field has-addons">
                            <div class="select">
                                <select name="study_trigger_condition" id="study_trigger_condition">
                                    <option value="timeout" {% if rules[rule]['study_trigger_condition']=='timeout'
                                        %}selected{% endif%}>Timeout Reached
                                    </option>
                                    <option value="received_series" {% if
                                        rules[rule]['study_trigger_condition']=='received_series' %}selected{% endif%}>
                                        Listed Series Received
                                    </option>
                                </select>
                            </div>
                            <div class="control is-expanded" style="margin-left: 10px;">
                                <div class="field has-addons" id="study_trigger_series_section">
                                    <input name="study_trigger_series" id="study_trigger_series" pattern="[^{}\x22]+"
                                        class="input series_completion_fix" autocomplete='off' type="text"
                                        placeholder="Series required for completion"
                                        value="{{rules[rule]['study_trigger_series']}}">
                                    <button class="button" type="button" id="showtestcompletionseries" title="Test rule">
                                        <i class="fas fa-spell-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field" id="force_study_completion_field">
                        <label class="label">Action for Incomplete Studies</label>
                        <div class="select">
                            <div class="control">
                                <select name="study_force_completion_action" id="study_force_completion_action">
                                    <option value="discard" {% if
                                        rules[rule]['study_force_completion_action']=='discard' %}selected{% endif%}>
                                        Discard Study
                                    </option>
                                    <option value="proceed" {% if
                                        rules[rule]['study_force_completion_action']=='proceed' %}selected{% endif%}>
                                        Proceed with Received Series
                                    </option>
                                    <option value="ignore" {% if
                                        rules[rule]['study_force_completion_action']=='ignore' %}selected{% endif%}>
                                        Ignore Timeout and Wait
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field" style="margin-top: 40px;">
                        <label class="label">Priority</label>
                        <div class="select">
                            <div class="control">
                                <select name="priority" id="priority">
                                    <option value="normal" {% if rules[rule]['priority']=='normal' %}selected{% endif%}>
                                        Normal</option>
                                    <option value="urgent" {% if rules[rule]['priority']=='urgent' %}selected{% endif%}>
                                        Urgent</option>
                                    <option value="offpeak" {% if rules[rule]['priority']=='offpeak' %}selected{%
                                        endif%}>Off-Peak</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field" style="margin-top: 40px;">
                        <label class="label">Status</label>
                        <div class="select" style="display: none;">
                            <div class="control">
                                <select name="disabled">
                                    <option value="False" {% if rules[rule]['disabled']==True %}selected{% endif%}>
                                        Enabled</option>
                                    <option value="True" {% if rules[rule]['disabled']==True %}selected{% endif%}>
                                        Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <input id="status_disabled" type="checkbox" name="status_disabled"
                            class="switch is-danger is-rounded" value="True" {% if rules[rule]['disabled']==True
                            %}checked="checked" {% endif%}>
                        <label for="status_disabled">Disable Rule</label>
                    </div>
                    <div class="field">
                        <input id="status_fallback" type="checkbox" name="status_fallback"
                            class="switch is-dark is-rounded" value="True" {% if rules[rule]['fallback']==True
                            %}checked="checked" {% endif%}>
                        <label for="status_fallback">Fallback Rule</label>
                    </div>
                </div>
                <div class="panel" data-content="processing">
                    {% if process_runner == "docker" %}
                    <div class="field" id="modules_list">
                        <label class="label">Processing Steps</label>
                        <div class="control process_list" style="min-height: 40px;">                            
                            <input id="processing_module_list" name="processing_module_list" class="input" type="tags" placeholder="Add module(s)"
                            value="{{rules[rule]['processing_module']|join(',') if (rules[rule]['processing_module'].pop) else rules[rule]['processing_module']}}"
                            style="">
                        </div>
                    </div>
                    <div class="field">
                        <div class="field {% if process_runner == "docker" %}is-grouped is-grouped-right{% endif %}">
                            {% if process_runner == "docker" %}
                            {% else %}
                            <label class="label">Module</label>
                            {% endif %}
                            <div class="select">
                                <div class="control">
                                    <select id="processing_module" name="processing_module" style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">
                                        {% for t in modules %}
                                        <option value="{{t}}" {% if rules[rule]['processing_module']==t %}selected{%
                                            endif%}>{{ t }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% if process_runner == "docker" %}
                                <a class="button is-link" id="add-module" style="border-top-left-radius: 0px; border-bottom-left-radius: 0px;" title="Insert selected module"><i class="fas fa-plus"></i></a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="field">
                        <label class="label">Settings</label>
                        <div class="control">
                            <textarea name="processing_settings" id="processing_settings" class="textarea monofont"
                                autocomplete='off' rows="10"
                                data-json
                                placeholder="Rule-specific module settings">{{processing_settings}}</textarea>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Data Flow</label>
                        <input id="processing_retain_images" type="checkbox" name="processing_retain_images"
                            class="switch is-rounded is-dark" value="True" {% if
                            rules[rule]['processing_retain_images']==True %}checked="checked" {% endif%}>
                        <label for="processing_retain_images">Retain Input Images</label>
                    </div>                    
                </div>
                <div class="panel" data-content="routing">
                    <div class="field">
                        <label class="label">Target(s)</label>
                        <div class="select is-multiple" id="target_control" style="width: 100%;">
                            <div class="control">
                                <select class="target_select" multiple id="target" name="target" size="{{ [targets|length,16]|min }}">
                                    {% for t in targets %}
                                    <option value="{{t}}" {% if t in rules[rule]['target'] %}selected{% endif%}>{{ t }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel" data-content="notification" style="margin-top: 30px;">
                    {% if phi_notifications %}
                    <div class="notification is-warning">
                        <i class="fas fa-info-circle"></i>&nbsp;&nbsp;This server is configured to allow patient health information (PHI) in notifications. Please use extra caution when setting up notifications.
                    </div>                    
                    {% else %}            
                    <div class="notification is-info">
                        <i class="fas fa-info-circle"></i>&nbsp;&nbsp;Using patient health information (PHI) in notifications is disabled for this server. Variables containing PHI will not be rendered.
                    </div>                    
                    {% endif %}                    
                    <div class="field">
                        <label class="label">Webhook URL</label>
                        <div class="control">
                            <input name="notification_webhook" class="input" autocomplete='off' type="url"
                                pattern="https://.*" placeholder="REST endpoint (leave empty to disable)"
                                value="{{rules[rule]['notification_webhook']}}">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Webhook Body</label>
                        <div class="control">
                            <textarea name="notification_payload_body" id="notification_payload_body" class="textarea textarea_scroll"
                                autocomplete="off" rows="6"
                                placeholder="Free text for body of REST call">{{rules[rule]['notification_payload_body']}}</textarea>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">JSON Payload</label>
                        <div class="control">
                            <textarea name="notification_payload" id="notification_payload" class="textarea textarea_scroll"
                                autocomplete="off" rows="6"
                                data-json
                                placeholder="JSON Payload for REST call">{% if rules[rule]['notification_payload'] %}{ {{rules[rule]['notification_payload']}} }{% endif %}</textarea>
                        </div>
                    </div>                    
                    <div class="field is-grouped is-grouped-right">
                        <div class="dropdown is-right">
                            <div class="dropdown-trigger">
                                <button class="button" type="button" aria-haspopup="true" aria-controls="dropdown-menu">
                                    <span><i class="fas fa-code"></i>&nbsp;Insert Template</span>
                                    <span class="icon is-small"><i class="fas fa-angle-down"
                                            aria-hidden="true"></i></span>
                                </button>
                            </div>
                            <div class="dropdown-menu" id="dropdown-menu" role="menu">
                                <div class="dropdown-content">
                                    <a href="#" id="template_slack" class="dropdown-item">
                                        Slack
                                    </a>
                                    <a href="#" id="template_webex" class="dropdown-item">
                                        WebEx Teams
                                    </a>
                                    <a href="#" id="template_yarramailbox" class="dropdown-item">
                                        Yarra Mailbox
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field" style="margin-top: 40px;">
                        <label class="label">Email Address</label>
                        <div class="control">
                            <input name="notification_email" class="input" autocomplete='off' type="email"
                                placeholder="Email address (leave empty to disable)"
                                value="{{rules[rule]['notification_email']}}">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Email Body</label>
                        <div class="control">
                            <textarea name="notification_email_body" id="notification_email_body" class="textarea textarea_scroll"
                                autocomplete="off" rows="9"
                                placeholder="Contents of notification email">{{rules[rule]['notification_email_body']}}</textarea>
                        </div>
                    </div>
                    <div class="field  is-grouped is-grouped-right">
                        <input id="notification_email_html" type="checkbox" name="notification_email_html"
                            class="switch is-rounded is-dark" value="false" {% if
                            rules[rule]['notification_email_type']=='html' %}checked="checked" {% endif%}>
                        <label for="notification_email_html">HTML Content</label>
                    </div>
                    <div class="field" style="margin-top: 40px;">
                        <label class="label">Trigger</label>
                    </div>
                    <div class="field">
                        <input id="notification_trigger_reception" type="checkbox" name="notification_trigger_reception"
                            class="switch is-rounded is-dark" value="True" {% if
                            rules[rule]['notification_trigger_reception']==True %}checked="checked" {% endif%}
                            >
                        <label for="notification_trigger_reception" title="Triggered when a series/study has been received that fulfills the selection rule">Reception</label>
                    </div>
                    <div class="field">
                        <input id="notification_trigger_completion_on_request" type="checkbox"
                            name="notification_trigger_completion_on_request" class="switch is-rounded is-dark" value="True" {% if
                            rules[rule]['notification_trigger_completion_on_request']==True %}checked="checked" {% endif%}>
                        <label for="notification_trigger_completion_on_request" title="Triggered if a processing module requests that a notification should be sent">Processing Result</label>
                    </div>
                    <div class="field">
                        <input id="notification_trigger_completion" type="checkbox"
                            name="notification_trigger_completion" class="switch is-rounded is-dark" value="True" {% if
                            rules[rule]['notification_trigger_completion']==True %}checked="checked" {% endif%}>
                        <label for="notification_trigger_completion" title="Triggered when all actions for a series/study have been completed">Completion</label>
                    </div>
                    <div class="field">
                        <input id="notification_trigger_error" type="checkbox" name="notification_trigger_error"
                            class="switch is-rounded is-dark" value="True" {% if
                            rules[rule]['notification_trigger_error']==True %}checked="checked" {% endif%}>
                        <label for="notification_trigger_error" title="Triggered if an error occurs while processing the rule">Error</label>
                    </div>
                </div>
                <div class="panel" data-content="information">
                    <div class="field">
                        <label class="label">Comment</label>
                        <div class="control">
                            <textarea name="comment" class="textarea textarea_scroll" autocomplete='off' rows="5"
                                placeholder="Rule description">{{rules[rule]['comment']}}</textarea>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Contact</label>
                        <div class="control">
                            <input name="contact" class="input" autocomplete='off' type="email"
                                placeholder="Email address" value="{{rules[rule]['contact']}}">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Tags</label>
                        <div class="control" style="min-height: 40px;">
                            <input id="tags" name="tags" class="input" type="tags" placeholder="Add tags"
                                value="{{rules[rule]['tags']|strip_untrusted}}"
                                style="height: 36px !important; font-size: 13.33px !important;" autocomplete="off">
                        </div>
                    </div>
                </div>
            </div>
            <div class="field">
                <div class="control buttons is-expanded" style="margin-top: 50px;">
                    <button type="submit" class="button is-success" value="default action" id="savebutton">
                        <span class="icon"><i class="fas fa-save"></i></span><span>Save</span>
                    </button>
                    <a class="button" href="/rules"><span class="icon"><i class="fas fa-ban"></i></span><span>Cancel</span></a>
                </div>
            </div>
        </form>
    </div>
</main>

<div class="modal" id="testcompletionseries">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 768px;">
        <header class="modal-card-head">
            <p class="modal-card-title">Required Series</p>
        </header>
        <section class="modal-card-body">
            <div class="container">
                <div class="field">
                    <label class="label">Example:</label>
                    <div>'Axial T2' and ('Sag T1 GRE' or 'Sag T1 TSE')</div>
                </div>
                <div class="field">
                    <label class="label">Current Value:</label>
                    <div id="testcompletionseriesresult" style="height: 3em;"></div>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot buttons is-centered">
            <button style="display: none;" class="button" id="evaltestcompletionseries" hx-post="/rules/test_completionseries"
                hx-include="#study_trigger_series" hx-target="#testcompletionseriesresult">Test</button>            
            <button class="button" type="button" id="closetestcompletionseries">Close</button>
        </footer>
    </div>
</div>

<div id="quickviewDefault" class="quickview">
    <header class="quickview-header quickviewtitle">
        <p class="title">Rule Notation</p>
        <span class="delete" data-dismiss="quickview"></span>
    </header>
    <div class="quickview-body textarea_scroll">
        <div class="quickview-block" style="margin-left: 20px; margin-right: 20px; margin-top: 20px;">
            <div class="table-container">
                <label class="label">Examples:</label>
                <table class="table is-fullwidth is-hoverable is-bordered">
                    <tr>
                        <td>(tags.Modality == 'MR') and ('GRASP' in tags.StudyDescription)</td>
                    </tr>
                    <tr>
                        <td>(float(tags.SeriesNumber) > 100) or (tags.ScanningSequence.lower()=='gr')</td>
                    </tr>
                </table>
            </div>
            <div class="table-container">
                <label class="label">Available Tags:</label>
                <table class="table is-fullwidth is-hoverable is-bordered">
                    {% for tag in sortedtags %}
                    <tr>
                        <td><button class="button is-small is-dark tag-copy" value="tags.{{tag}}">Copy</button> &nbsp;&nbsp;tags.{{tag}}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            <input type="text" id="copyinput" value="test" style="display: none;">
        </div>
    </div>
    <footer class="quickview-footer is-centered buttons">
        <button class="button" type="button" data-dismiss="quickview">Close</button>
    </footer>
</div>

<script nonce="{{ csp_nonce }}">
    function validate() {
        var field = "";
        try {
            field = "Processing > Settings";
            if ($('#processing_settings').val() == "") {
                $('#processing_settings').val("{}");
            }
            JSON.parse($('#processing_settings').val());
            field = "Notification > Payload";
            if ($('#notification_payload').val() == "") {
                $('#notification_payload').val("{}");
            }
            JSON.parse($('#notification_payload').val());
        } catch (e) {
            $('#erroralert').html('<i class="fas fa-bug"></i>&nbsp;&nbsp;Invalid content in field "' + field + '". Please check for correct syntax.');
            $('#erroralert').show();
            return false;
        }

        if (($('#action').val() == 'process') || ($('#action').val() == 'both')) {
            if (bulmaTagsInstances[0].tags.length == 0) {
                $('#erroralert').html('<i class="fas fa-bug"></i>&nbsp;&nbsp;Processing Steps cannot be empty. Add at least one module.');
                $('#erroralert').show();
                $('#processing_id').click();
                $('#modules_list .tagsinput').addClass("is-danger");
                $('#processing_module').focus();
                return false;
            }
        }

        if (($('#action').val() == 'route') || ($('#action').val() == 'both')) {
            if ($('#target').val() == '') {
                $('#erroralert').html('<i class="fas fa-bug"></i>&nbsp;&nbsp;Targets cannot be empty. Select at least one target.');
                $('#erroralert').show();
                $('#routing_id').click();
                $('#target').addClass("is-danger");
                $('#target_control').addClass("is-danger");
                $('#target').focus();
                return false;
            }
        }

        return true;
    }
    $('form').on('submit', validate);
    $('#rule').on('keyup', (evt)=> evt.target.value = evt.target.value.replace(/[{}\n]/g, ''))
    $('#study_trigger_series').on('keyup', (evt)=> evt.target.value = evt.target.value.replace(/[{}\x22\n]/g, ''))
    
    function toggleTestRule() {
        if($("#testrule").is(":visible")) {
            $("#testrule").hide();
            $("#toggletestrule").removeClass("is-dark");
        }
        else {
            $("#testrule").show();
            $("#toggletestrule").addClass("is-dark");
            $("#evaltestrule").click();
        }      
    }
    $("#toggletestrule").click(toggleTestRule);

    function resetTestRule() {
        resetTags = {{alltags|tojson(indent=4)}};
        $('#testvalues').val(JSON.stringify(resetTags, null, '    '));
        $("#dropZone article").removeClass("is-danger").removeClass("is-dark").addClass("ruletesterdashed");
        $("#dropStatus").text("");
        $('#evaltestrule').click()
    }
    $('resettestrule').click(resetTestRule);

    function showTestCompletionSeries() {
        $("#testcompletionseries").addClass("is-active");
        $("#evaltestcompletionseries").click();
    }
    $('showtestcompletionseries').click(showTestCompletionSeries);

    function closeTestCompletionSeries() {
        $("#testcompletionseries").removeClass("is-active");
    }
    $('closetestcompletionseries').click(closeTestCompletionSeries);

    function copyTag(value) {
        $("#copyinput").val(value);
        $("#copyinput").css("display", "block");

        var copyText = document.getElementById("copyinput");
        copyText.select();
        document.execCommand("copy");

        $("#copyinput").css("display", "none");
    }
    $('.tag-copy').click((evt)=>copyTag(evt.target.value))
    $(function () {
        $('#rule').keypress(function (e) {
            if (e.which == 13) {
                $("#evaltestrule").click();
                return false;
            }
            var chr = String.fromCharCode(e.which);
            if ("{}".indexOf(chr) >= 0)
                return false;
        });
    });

    $('#rule').on('input', function (e) {
        if (e.target.value.indexOf("\n") < 0) {
            $(this).outerHeight(36).outerHeight(this.scrollHeight + 1);
        }
    });

    /*
    $("#target").mousedown(function(e){
        e.preventDefault();        
        var select = this;
        var scroll = select.scrollTop;       
        if (!e.target.selected) {
            e.target.selected=true;
        } else {
            if (document.getElementById("target").selectedOptions.length > 1) {
                e.target.selected=false;
            }
        }
        setTimeout(function(){select.scrollTop = scroll;}, 0);        
        $(select).focus();
    }).mousemove(function(e){e.preventDefault()});
    */

    $(document).ready(function () {

        var targetSelector = new Choices('#target', {
          removeItemButton: true, searchEnabled: true,
          placeholder: true,
          placeholderValue: "Click to select target(s)",          
          noResultsText: 'No matching targets found',
          noChoicesText: 'No other targets to choose from',          
        });        

        var quickviews = bulmaQuickview.attach();

        $('#rule').outerHeight($('#rule').prop('scrollHeight') + 1);

        $('#tabs li').on('click', function () {
            var tab = $(this).data('tab');

            $('#tabs li').removeClass('is-active');
            $(this).addClass('is-active');

            $('#tab-content div.panel').removeClass('is-active');
            $('div.panel[data-content="' + tab + '"]').addClass('is-active');
        });

        $('#add-module').click(function() {
            bulmaTagsInstances[0].addTag($("#processing_module").val());
            bulmaTagsInstances[0].save();
        })
        $('#action').change(function () {
            var action = $(this).children("option:selected").val();

            if (action == 'route') {
                $('#tabs li[data-tab="processing"]').addClass('is-disabled');
                $('#tabs li[data-tab="routing"]').removeClass('is-disabled');
            }
            if (action == 'both') {
                $('#tabs li[data-tab="processing"]').removeClass('is-disabled');
                $('#tabs li[data-tab="routing"]').removeClass('is-disabled');
            }
            if (action == 'process') {
                $('#tabs li[data-tab="processing"]').removeClass('is-disabled');
                $('#tabs li[data-tab="routing"]').addClass('is-disabled');
            }
            if ((action == 'discard') || (action == 'notification')) {
                $('#tabs li[data-tab="processing"]').addClass('is-disabled');
                $('#tabs li[data-tab="routing"]').addClass('is-disabled');
            }
        });

        $('#action_trigger').change(function () {
            var action_trigger = $(this).children("option:selected").val();
            var study_trigger = $('#study_trigger_condition').children("option:selected").val();

            if (action_trigger == 'series') {
                $('#study_trigger_field').hide();
                $("#force_study_completion_field").hide();
                $('#study_trigger_series').prop('required', false);
            } else {
                $('#study_trigger_field').show();
                if (study_trigger == 'received_series') {
                    $("#force_study_completion_field").show();
                }
            }
        });

        $('#study_trigger_condition').change(function () {
            var study_trigger = $(this).children("option:selected").val();

            if (study_trigger == 'timeout') {
                $('#study_trigger_series_section').hide();
                $('#study_trigger_series').prop('required', false);
                $("#force_study_completion_field").hide();
            } else {
                $('#study_trigger_series_section').show();
                $('#study_trigger_series').prop('required', true);
                $("#force_study_completion_field").show();
            }
        });

        $("#action").trigger('change');
        $("#action_trigger").trigger('change');
        $("#study_trigger_condition").trigger('change');

        var dropdown = document.querySelector('.dropdown');
        dropdown.addEventListener('click', function (event) {
            event.stopPropagation();
            dropdown.classList.toggle('is-active');
        });
        {% raw %}
        var body_template = "Rule {{ rule }} triggered {{ event }}\n{% if details is defined and details|length %}\nDetails:\n{{ details }}\n{%endif%}"
        $('#template_slack').click(function () {
            $('#notification_payload').val('{\n    "text": "{{ body }}",\n    "channel": "YOUR_CHANNEL_ID"\n}');
            $('#notification_payload').trigger("input");
        });

        $('#template_webex').click(function () {
            $('#notification_payload').val('{\n    "text": "{{ body }}"\n}');
            $('#notification_payload').trigger("input");
        });

        $('#template_yarramailbox').click(function () {
            $('#notification_payload').val('{\n    "content": "{{ body }}",\n    "client_serial": "{{ DeviceSerialNumber }}",\n    "timeout": "2 hours",\n    "options": {},\n    "api_key": "INSERT_API_KEY"\n}');
            $('#notification_payload').trigger("input");
        });
        {% endraw %}

        $("#savebutton").click(function(){
            if ($("#action_trigger").val() == 'series') {
                $('#study_trigger_series').prop('required', false);
            }
        });       

        // Obtain a list of the tags that should be read from the DICOM file
        tagsToGet = {{alltags|list|tojson}}

        function dumpDataSet(dataSet, output)
        {
            function getTag(tag)
            {
                var group = tag.substring(1,5);
                var element = tag.substring(5,9);
                var tagIndex = ("("+group+","+element+")").toUpperCase();
                var attr = TAG_DICT[tagIndex];
                if (typeof(attr) == "undefined") {
                    attr = "";
                }
                return attr;
            }

            try {
                var keys = [];
                for(var propertyName in dataSet.elements) {
                    keys.push(propertyName);
                }
                keys.sort();
                for(var t of tagsToGet){
                    output[t] = ""
                }
                for(var k=0; k < keys.length; k++) {
                    var propertyName = keys[k];
                    var element = dataSet.elements[propertyName];
                    var tag = getTag(element.tag);
                    if (tagsToGet.indexOf(tag.name) >= 0) {
                        output[tag.name] = dataSet.string(propertyName)
                    }
                }
            } catch(err) {
                var ex = {
                    exception: err,
                    output: output
                }
                throw ex;
            }

            for (var tag in tagsToGet) {
                if (!(tagsToGet[tag] in output)) 
                {
                    output[tagsToGet[tag]] = "";
                } else {
                    if (typeof(output[tagsToGet[tag]]) == "undefined")
                    {
                        output[tagsToGet[tag]] = "";
                    }
                }
            }
        }

        function dumpFile(file)
        {
            $("#dropZone article").removeClass("ruletesterdashed")            
            var reader = new FileReader();
            reader.onload = function(k) {
                var arrayBuffer = reader.result;
                // Here we have the file data as an ArrayBuffer.  dicomParser requires as input a Uint8Array so we create that here
                var byteArray = new Uint8Array(arrayBuffer);
                try {
                    dataSet = dicomParser.parseDicom(byteArray, {"untilTag": "x7fe00010"});
                    output = {}
                    dumpDataSet(dataSet,output)
                    // Inform user if the DICOM uses an unsupported character set (the JS library is not doing a transformation)
                    if (output["SpecificCharacterSet"] != undefined && output["SpecificCharacterSet"] != "" && output["SpecificCharacterSet"] != "ISO_IR 100" && output["SpecificCharacterSet"] != "ISO_IR 192") {
                        $("#characterSetWarning").removeClass("is-hidden")
                    } else {
                        $("#characterSetWarning").addClass("is-hidden")
                    }
                    // Sort the keys alphabetically
                    const orderedOutput = Object.keys(output).sort().reduce(
                        (obj, key) => { 
                            obj[key] = output[key]; 
                            return obj;
                        }, 
                        {}
                    );
                    $("#dropZone article").removeClass("is-danger").addClass("is-dark")
                    $("#dropStatus").text("Loaded tags from DICOM file " + file.name)
                    $('#testvalues').val(JSON.stringify(orderedOutput, null, '    '))
                    $('#evaltestrule').click()
                } catch (e) {
                    $("#dropZone article").addClass("is-danger").removeClass("is-primary").removeClass("is-info")
                    $("#dropStatus").text("Error: " + e)
                    $("#testresult").html('<span class="tag tag has-text-white has-background-grey is-medium ruleresult">Unknown</a>')
                    console.error(e)
                }
            }
            try { 
                reader.readAsArrayBuffer(file);
            } catch (e) {
                $("#dropZone article").addClass("is-danger").removeClass("is-dark")
                $("#dropStatus").text("Error: " + e)
                $("#testresult").html('<span class="tag tag has-text-white has-background-grey is-medium ruleresult">Unknown</a>')
                console.error(e)
            }
        }

        function handleFileSelect(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            $("#dropZone article").css("outline","")
            // Get the FileList object that contains the list of files that were dropped
            var files = evt.dataTransfer.files;

            // this UI is only built for a single file so just dump the first one
            $("#dropStatus").text("Parsing...")
            dumpFile(files[0]);
        }

        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            $("#dropZone article").css("outline","4px dashed #3273dc")
        }

        function handleDragLeave(evt) {
            $("#dropZone article").css("outline","")
        }

        var dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('dragleave', handleDragLeave, false);
        dropZone.addEventListener('drop', handleFileSelect, false);
    });
</script>
<script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='/js/bulma-tagsinput.min.js') }}"></script>
<script nonce="{{ csp_nonce }}">
    var bulmaTagsInstances = bulmaTagsinput.attach();
    window.setTimeout(function(){$("#modules_list input").attr("readonly","true")},200)   
    // bulmaTagsInstances[0].container.getElementsByTagName("input")[0].setAttribute("readonly",1)
</script>

{% endblock %}
